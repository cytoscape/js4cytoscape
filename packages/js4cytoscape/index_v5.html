<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="img/tab.png">
    <title>App Manager</title>
  </head>
  <style>
  h3 {
    text-align: center;
      }
  body {
    font-size: 1rem;
    font-family: Helvetica, Arial, sans-serif;
  }
  a.app{
    text-decoration: none;
    font-size: 1.1rem;
    color: black;
    vertical-align: top;
  }
  .center-text {
        text-align: center;
        display: block;
      }
  td {
    vertical-align: top;
     /* padding: 5px; */
  }
  enablecheck:checked {
    background-color: #F7941E;
  }
  .btn {
    border-radius: 30px;
    border-width: thin;
    border-color: #F7941E;
  }
  .btn:focus {
    color: grey;
  }
  .btn-enabled{
    background-color: #F7941E; /* cytoscape orange */
    color: white;
  }
  .btn-disabled{
    background-color: white; 
    color: #F7941E;
  }
  .center {
    margin: auto;
    width: 500px;
    border: 5px;
    padding: 10px;
  }

  </style>

  <body>

    <div class="center">
        <p style="margin-left:10px; margin-top:0px;">Manage your installed apps below. <br />Visit 
            the <a onClick="openAppStore();" style="cursor: pointer; cursor: hand; color:blue; text-decoration:underline;">App Store</a> to find new apps.
            
        </p>
        <table id ="enabledApps">
            <tr><td style="align:center; background-color: #EEDDDD; width:25px;height:25px;">
                <img src="img/trash.png" height="18px" style="float:left;margin:4px 0 0 3px;" onclick="uninstallAllApps()" title="Uninstall all apps"></td>
                <td style="align:center; background-color: #EEDDDD; width:25px;height:25px;">
                <button style="width: 16px;height: 16px; margin-left:4px; margin-top: 5px; background-color: #EEEEEE; border: 1px solid #999999;" 
                    onclick="disableAllApps()" title="Disable all apps"></button></td>
                <td style="align:center; background-color: #EEDDDD; width:25px;height:25px;">
                    <img src="img/update1.png" height="18px" style="float:left;margin:4px 0 0 3px;" onclick="updateAllApps()" title="Update all apps"></td>
                <td ></td>
            </tr>
        </table>
        <table id ="disabledApps"></table>
    </div>
     
<!-- Additional JavaScript -->
<script type="text/javascript">
window.addEventListener('load', function() { 
    // if(window.navigator.userAgent.includes('CyBrowser')){  
        // alert("CyBrowser detected!");
        setTimeout(function(){
            renderInstalledApps('enabledApps');
            renderDisabledApps('disabledApps');
        }, 200);

    // }
});
 
function showCybResult(res){
    alert(res);
}

function openAppStore(){
    cybrowser.executeCyCommand('cybrowser dialog url="https://apps.cytoscape.org" id="AppStore" title="App Store" ');
}


const coreApps = ["BioPAX Reader",  "Biomart Web Service Client", "CX Support",
                  "Core Apps", "CyNDEx-2", "CyCL", "Diffusion", "FileTransfer",
                  "ID Mapper", "JSON Support", "Network Merge", "NetworkAnalyzer",
                  "OpenCL Prefuse Layout", "PSI-MI Reader", "PSICQUIC Web Service Client",
                  "SBML Reader", "aMatReader", "copycatLayout", "cyBrowser",
                  "cyChart", "cyREST"]


function renderInstalledApps(tabId) {  
    // alert("renderInstalledApps called!");
    let apps = Promise.resolve(getInstalledAppsCyB())
    apps.then(data => {
        array = data.split('\n');
        array = array.map(function(a){
            a = a.split(',');
            a = a.map(function(i){
                i = i.split(': ')[1];
                return i;
            })
            return a;
        });
        array.forEach(app => {
            var aname=app[0];
            if (typeof aname == 'undefined') { aname = "";} //resolve null
            var anamevar = aname.replace(/\W/g,"");
            var aver=app[1];
            var astat=app[2];
            if (aname.length > 0 && !coreApps.includes(aname)){
                arow = '<tr><td style="align:center; background-color: #EEEEEE; width:25px;height:25px;"><img src="img/trash.png" height="18px" style="float:left;margin:4px 0 0 3px;" onclick="uninstallAndRemove(&quot;'+anamevar+'&quot;)" title="Uninstall app"></td>';
                arow += '<td style="align:center; background-color: #EEEEEE; width:25px;height:25px;"><input type="checkbox" id="'+anamevar+'" name="enablecheck" tabindex="0"  checked ' +
                    'onchange="switchToggleAndReload(this, &quot;'+anamevar+'&quot;);" title="Toggle enabled status"></td>';   
                arow += '<td style="align:center; background-color: #EEEEEE; width:25px;height:25px;"><img src="img/update1.png" height="18px" style="float:left;margin:4px 0 0 3px;" title="No update available"</td>'; 
                arow += '<td>&nbsp;&nbsp;<a href="https://apps.cytoscape.org/apps/'+anamevar+'" class="app" title="Visit App Store page">'+aname+'</a> (v'+aver+') </td></tr>';        
                document.getElementById(tabId).innerHTML += arow;
            }
        });
    });
}

function renderDisabledApps(tabId) {  
    let apps = Promise.resolve(getDisabledAppsCyB())
    apps.then(data => {
        array = data.split('\n');
        array = array.map(function(a){
            a = a.split(',');
            a = a.map(function(i){
                i = i.split(': ')[1];
                return i;
            })
            return a;
        });
        array.forEach(app => {
            var aname=app[0];
            if (typeof aname == 'undefined') { aname = "";} //resolve null
            var anamevar = aname.replace(/\W/g,"");
            var aver=app[1];
            var astat=app[2];
            if (aname.length > 0 && !coreApps.includes(aname)){
                arow = '<tr><td style="background-color: #EEEEEE; width:25px;height:25px;""><img src="img/trash.png" height="18px" style="float:left;margin:4px 0 0 3px;" onclick="uninstallAndRemove(&quot;'+anamevar+'&quot;)" title="Uninstall app"></td>';
                arow += '<td style="background-color: #EEEEEE; width:25px;height:25px;""><input type="checkbox" id="'+anamevar+'" tabindex="0" ' +
                    'onchange="switchToggleAndReload(this, &quot;'+anamevar+'&quot;);" title="Toggle enabled status"></td>';    
                arow += '<td style="align:center; background-color: #EEEEEE; width:25px;height:25px;"><img src="img/update1.png" height="18px" style="float:left;margin:4px 0 0 3px;" onclick="updateAppAndIcon(&quot;'+anamevar+'&quot;)" title="Update app"></td>'; 
                arow += '<td>&nbsp;&nbsp;<a href="https://apps.cytoscape.org/apps/'+anamevar+'" class="app" title="Visit App Store page">'+aname+'</a> (v'+aver+') </td></tr>';

                document.getElementById(tabId).innerHTML += arow;
            }
        });
    });
    
}

async function switchToggleAndReload(checkbox, app) {
    if(checkbox.checked == true){
        let res = await enableAppCyB(app);
    }else{
        let res = await disableAppCyB(app);
   }
//    location.reload(true);
}

async function uninstallAndRemove(app) {
    let res = await uninstallAppCyB(app);
    // remove from table
    var table = document.getElementById("enabledApps");
    for (var i = 0, row; row = table.rows[i]; i++) {
        anamevar = row.cells[3].textContent.replace(/\(.*\)/g,"")
        anamevar = anamevar.replace(/\W/g,"");
        if (anamevar ==  app) {
            row.remove();
        }
    }
    var table = document.getElementById("disabledApps");
    for (var i = 0, row; row = table.rows[i]; i++) {
        anamevar = row.cells[3].textContent.replace(/\(.*\)/g,"")
        anamevar = anamevar.replace(/\W/g,"");
        if (anamevar ==  app) {
            row.remove();
        }
    }
}

async function disableAllApps() {
    //TODO
}
async function uninstallAllApps() {
    //TODO
}

async function getInstalledAppsCyB() {
    let res = await commandsGETLocal('apps list installed'); // commandsGETLocal | cybrowser.executeCyCommand
    return res;
}

async function getDisabledAppsCyB() {
    let res = await commandsGETLocal('apps list disabled'); 
    return res;
}
async function getAppUpdatesCyB() {
    let res = await cybrowser.executeCyCommand('apps list updates');
    return res;
}
async function disableAppCyB(app) {
    let res = await cybrowser.executeCyCommand('apps disable app=' + "'" + app + "'");
    return res;
}
async function enableAppCyB(app) {
    let res = await cybrowser.executeCyCommand('apps enable app=' + "'" + app + "'");
    return res;
}
async function uninstallAppCyB(app) {
    let res = await cybrowser.executeCyCommand('apps uninstall app=' + "'" + app + "'");
    return res;
}


/***************************
// FUNCTIONS FOR ONLINE ONLY
****************************/

async function updateAppAndIcon(app) {
    let res = await unpdateAppCyB(app);
    // update and swap update1.png icon back in for row
    //TODO
}

async function updateAppCyB(app) {
    //TODO
}
/**
 * Update an app or all apps.
 *
 * @param {String} tabId
 * @param {String} buttonId
 * @return null
 */
 async function updateAllApps(tabId, buttonId) {
    let res = await cybrowser.executeCyCommand('apps update app=');
    renderAllAppUpdates(tabId)
    checkUpdateApp(buttonId)
    return res;
}

/**
 * Return a list of the apps that have updates in the app store.
 *
 * @param {String} buttonId
 */
 async function checkUpdateApp(buttonId) {
    let res = await commandsGETLocal('apps list updates')
    const button = document.getElementById(buttonId);
    if (res.includes("name")) {
      //TODO: swap td for update2.png with onclick="updateAppAndIcon(&quot;'+anamevar+'&quot;)" title="Update app"
    } else {
      //do nothing
    }
}


async function commandsGETLocal(cmdString) {
  const qurl = command2getQueryLocal(cmdString)
  const res = await fetch(qurl, {
      method: 'GET',
      headers: {
        Accept: 'text/plain',
        'Content-Type': 'text/plain'
      }
    });
    const json = await res.text();
    return json;
}
function command2getQueryLocal(cmdString){
    let baseUrl = 'http://127.0.0.1:1234/v1';
    let pattern =  /\ [A-Za-z0-9_-]*=/g;
    let cmdMarkParams = cmdString.replace(pattern, "XXXXXX$&");
    let splitCmd = cmdMarkParams.split("XXXXXX");
    let cyCmd = splitCmd[0];
    let tempString = cyCmd.replace(" ", "/");
    let commandUrl = baseUrl.concat('/commands/')
    let url = encodeURI(commandUrl.concat(tempString));
    let args = (splitCmd.slice(1)).join(' ');
    let qargs = "";
    let keyList = [];
    let valueList = [];
    if (!(args === undefined || args.length == 0)) {
        args = args.replace(/['"]+/g, '');
        const re1 = /[A-Za-z0-9_-]+=/g;
        keyList = args.match(re1);
        keyList = keyList.map(function(x){ return x.replace(/=/g,"") });
        const re2 = /\ *[A-Za-z0-9_-]+=/g;
        valueList = args.split(re2).slice(1);
        qargs = keyList[0] + "=" + encodeURI(valueList[0]);
        for (var i = 1; i < keyList.length; i++){
          let tempArgs = keyList[i] + "=" + encodeURI(valueList[i]);
          qargs = qargs + "&" + tempArgs;
        }
        return url + "?" + qargs;
    } else {
        return url;
    }
}
    </script>
  </body>
</html>
